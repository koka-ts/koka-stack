import { ExecutionTree, CommandExecutionTree, QueryExecutionTree, Store, EventExecutionTree } from './koka-domain.ts'

type LoggerOptions = {
    colors?: boolean
    timestamp?: boolean
    showArgs?: boolean
    showReturn?: boolean
    showStates?: boolean
    showChanges?: boolean
    maxDepth?: number
    compactMode?: boolean
    groupOutput?: boolean
}

const defaultOptions: LoggerOptions = {
    colors: true,
    timestamp: true,
    showArgs: true,
    showReturn: true,
    showStates: true,
    showChanges: true,
    maxDepth: 10,
    compactMode: false,
    groupOutput: true,
}

// ÂõæÊ†áÔºà‰ΩøÁî® emoji Âú®ÊµèËßàÂô®‰∏≠ÊòæÁ§∫ÊïàÊûúÊõ¥Â•ΩÔºâ
const ICONS = {
    COMMAND: '‚ö°',
    QUERY: 'üîç',
    EVENT: 'üîî',
    ASYNC: '‚è≥',
    SUCCESS: '‚úì',
    ERROR: '‚úó',
    ARROW: '‚Üí',
    CHANGE: '‚àÜ',
    STATE: 'üìä',
    FOLDER: 'üìÅ',
    SEARCH: 'üîé',
}

// È¢úËâ≤ÂÆö‰πâ
const COLORS = {
    command: '#4CAF50',
    query: '#2196F3',
    event: '#FFC107',
    async: '#FF9800',
    success: '#4CAF50',
    error: '#F44336',
    gray: '#9E9E9E',
    magenta: '#9C27B0',
    blue: '#03A9F4',
}

// Ê†ºÂºèÂåñÂÄºÔºåÊô∫ËÉΩÂ§ÑÁêÜ‰∏çÂêåÁ±ªÂûã
const formatValue = (value: unknown, maxLength: number = 80): string => {
    if (value === undefined) return 'undefined'
    if (value === null) return 'null'

    try {
        const stringified = JSON.stringify(value)
        if (stringified.length <= maxLength) {
            return stringified
        }

        // ÂØπ‰∫éÈïøÂ≠óÁ¨¶‰∏≤ÔºåËøõË°åÊà™Êñ≠
        if (typeof value === 'string') {
            return `"${value.substring(0, maxLength - 5)}..."`
        }

        // ÂØπ‰∫éÂØπË±°ÂíåÊï∞ÁªÑÔºåÊòæÁ§∫ÊëòË¶Å
        if (Array.isArray(value)) {
            return `[Array(${value.length})]`
        }

        if (typeof value === 'object') {
            const keys = Object.keys(value)
            return `{${keys.slice(0, 3).join(', ')}${keys.length > 3 ? ', ...' : ''}}`
        }

        return stringified.substring(0, maxLength - 3) + '...'
    } catch {
        return String(value)
    }
}

// ÂëΩ‰ª§ÊâßË°åÊ†ëÊ†ºÂºèÂåñÂáΩÊï∞
const formatCommandTree = (tree: CommandExecutionTree, options: LoggerOptions, depth: number): void => {
    // ÊûÑÂª∫Â§¥ÈÉ®
    let header = `${ICONS.COMMAND} CMD: ${tree.domainName}.${tree.name}`
    if (tree.async) {
        header += ` ${ICONS.ASYNC}`
    }

    const headerStyle = `color: ${COLORS.command}; font-weight: bold; font-size: ${depth === 0 ? '14px' : '12px'}`

    // ÂàõÂª∫ÂàÜÁªÑ
    if (options.groupOutput) {
        if (depth === 0) {
            console.groupCollapsed(
                `%c${header}${options.timestamp ? ` [${new Date().toISOString()}]` : ''}`,
                headerStyle,
            )
        } else {
            console.group(`%c${header}`, headerStyle)
        }
    } else {
        console.log(`%c${header}`, headerStyle)
    }

    // ÂèÇÊï∞
    if (options.showArgs && tree.args.length > 0) {
        if (options.compactMode) {
            console.log(
                `%c  ${ICONS.ARROW} Args:`,
                `color: ${COLORS.gray}; font-weight: bold`,
                tree.args.map((arg) => formatValue(arg, 40)).join(', '),
            )
        } else {
            console.group(`%c  ${ICONS.ARROW} Args:`, `color: ${COLORS.gray}; font-weight: bold`)
            tree.args.forEach((arg, index) => {
                console.log(`[${index}]:`, arg)
            })
            console.groupEnd()
        }
    }

    // ÁªìÊûú
    if (options.showReturn && tree.result !== undefined) {
        if (tree.result.type === 'ok') {
            console.log(`%c  ${ICONS.ARROW} Result:`, `color: ${COLORS.success}; font-weight: bold`, tree.result.value)
        } else {
            console.log(`%c  ${ICONS.ERROR} Error:`, `color: ${COLORS.error}; font-weight: bold`, tree.result.error)
        }
    }

    // Áä∂ÊÄÅ
    if (options.showStates && tree.states.length > 0) {
        console.group(`%c  ${ICONS.STATE} States:`, `color: ${COLORS.magenta}; font-weight: bold`)
        tree.states.forEach((state, index) => {
            console.log(`[${index}]:`, state)
        })
        console.groupEnd()
    }

    // ÂèòÊõ¥
    if (options.showChanges && tree.changes.length > 0) {
        console.group(`%c  ${ICONS.CHANGE} Changes:`, `color: ${COLORS.event}; font-weight: bold`)
        tree.changes.forEach((change, index) => {
            if (options.compactMode) {
                console.log(
                    `[${index}]: %c${formatValue(change.previous, 30)}%c ‚Üí %c${formatValue(change.next, 30)}`,
                    `color: ${COLORS.error}`,
                    `color: ${COLORS.gray}`,
                    `color: ${COLORS.success}`,
                )
            } else {
                console.group(`Change [${index}]:`)
                console.log(`%cBefore:`, `color: ${COLORS.error}; font-weight: bold`, change.previous)
                console.log(`%cAfter:`, `color: ${COLORS.success}; font-weight: bold`, change.next)
                console.groupEnd()
            }
        })
        console.groupEnd()
    }

    // Â≠êÊâßË°åÊ†ë
    if (tree.commands.length > 0) {
        console.group(
            `%c  ${ICONS.FOLDER} Sub-Commands (${tree.commands.length}):`,
            `color: ${COLORS.blue}; font-weight: bold`,
        )
        tree.commands.forEach((cmd) => formatExecutionTree(cmd, options, depth + 1))
        console.groupEnd()
    }

    if (tree.queries.length > 0) {
        console.group(
            `%c  ${ICONS.SEARCH} Queries (${tree.queries.length}):`,
            `color: ${COLORS.blue}; font-weight: bold`,
        )
        tree.queries.forEach((query) => formatExecutionTree(query, options, depth + 1))
        console.groupEnd()
    }

    if (tree.events.length > 0) {
        console.group(`%c  ${ICONS.EVENT} Events (${tree.events.length}):`, `color: ${COLORS.blue}; font-weight: bold`)
        tree.events.forEach((event) => formatExecutionTree(event, options, depth + 1))
        console.groupEnd()
    }

    if (options.groupOutput) {
        console.groupEnd()
    }
}

// Êü•ËØ¢ÊâßË°åÊ†ëÊ†ºÂºèÂåñÂáΩÊï∞
const formatQueryTree = (tree: QueryExecutionTree, options: LoggerOptions, depth: number): void => {
    // ÊûÑÂª∫Â§¥ÈÉ®
    let header = `${ICONS.QUERY} QRY: ${tree.domainName}.${tree.name}`
    if (tree.async) {
        header += ` ${ICONS.ASYNC}`
    }

    const headerStyle = `color: ${COLORS.query}; font-weight: bold; font-size: ${depth === 0 ? '14px' : '12px'}`

    // ÂàõÂª∫ÂàÜÁªÑ
    if (options.groupOutput) {
        if (depth === 0) {
            console.groupCollapsed(
                `%c${header}${options.timestamp ? ` [${new Date().toISOString()}]` : ''}`,
                headerStyle,
            )
        } else {
            console.group(`%c${header}`, headerStyle)
        }
    } else {
        console.log(`%c${header}`, headerStyle)
    }

    // ÂèÇÊï∞
    if (options.showArgs && tree.args.length > 0) {
        if (options.compactMode) {
            console.log(
                `%c  ${ICONS.ARROW} Args:`,
                `color: ${COLORS.gray}; font-weight: bold`,
                tree.args.map((arg) => formatValue(arg, 40)).join(', '),
            )
        } else {
            console.group(`%c  ${ICONS.ARROW} Args:`, `color: ${COLORS.gray}; font-weight: bold`)
            tree.args.forEach((arg, index) => {
                console.log(`[${index}]:`, arg)
            })
            console.groupEnd()
        }
    }

    // ÁªìÊûú
    if (options.showReturn && tree.result !== undefined) {
        if (tree.result.type === 'ok') {
            console.log(`%c  ${ICONS.ARROW} Result:`, `color: ${COLORS.success}; font-weight: bold`, tree.result.value)
        } else {
            console.log(`%c  ${ICONS.ERROR} Error:`, `color: ${COLORS.error}; font-weight: bold`, tree.result.error)
        }
    }

    // Áä∂ÊÄÅ
    if (options.showStates && tree.states.length > 0) {
        console.group(`%c  ${ICONS.STATE} States:`, `color: ${COLORS.magenta}; font-weight: bold`)
        tree.states.forEach((state, index) => {
            console.log(`[${index}]:`, state)
        })
        console.groupEnd()
    }

    // Â≠êÊü•ËØ¢
    if (tree.queries.length > 0) {
        console.group(
            `%c  ${ICONS.SEARCH} Sub-Queries (${tree.queries.length}):`,
            `color: ${COLORS.blue}; font-weight: bold`,
        )
        tree.queries.forEach((query) => formatExecutionTree(query, options, depth + 1))
        console.groupEnd()
    }

    if (options.groupOutput) {
        console.groupEnd()
    }
}

// ‰∫ã‰ª∂ÊâßË°åÊ†ëÊ†ºÂºèÂåñÂáΩÊï∞
const formatEventTree = (tree: EventExecutionTree, options: LoggerOptions, depth: number): void => {
    // ÊûÑÂª∫Â§¥ÈÉ®Ôºà‰∫ã‰ª∂ÊÄªÊòØÂºÇÊ≠•ÁöÑÔºâ
    const header = `${ICONS.EVENT} EVT: ${tree.domainName}.${tree.name} ${ICONS.ASYNC}`
    const headerStyle = `color: ${COLORS.event}; font-weight: bold; font-size: ${depth === 0 ? '14px' : '12px'}`

    // ÂàõÂª∫ÂàÜÁªÑ
    if (options.groupOutput) {
        if (depth === 0) {
            console.groupCollapsed(
                `%c${header}${options.timestamp ? ` [${new Date().toISOString()}]` : ''}`,
                headerStyle,
            )
        } else {
            console.group(`%c${header}`, headerStyle)
        }
    } else {
        console.log(`%c${header}`, headerStyle)
    }

    // PayloadÔºà‰∫ã‰ª∂ÁâπÊúâÁöÑÔºâ
    if (options.showArgs && tree.payload !== undefined) {
        console.log(`%c  ${ICONS.ARROW} Payload:`, `color: ${COLORS.gray}; font-weight: bold`, tree.payload)
    }

    // Ëß¶ÂèëÁöÑÂëΩ‰ª§
    if (tree.commands.length > 0) {
        console.group(
            `%c  ${ICONS.FOLDER} Commands (${tree.commands.length}):`,
            `color: ${COLORS.blue}; font-weight: bold`,
        )
        tree.commands.forEach((cmd) => formatExecutionTree(cmd, options, depth + 1))
        console.groupEnd()
    }

    if (options.groupOutput) {
        console.groupEnd()
    }
}

// ‰∏ªÊ†ºÂºèÂåñÂáΩÊï∞
const formatExecutionTree = (tree: ExecutionTree, options: LoggerOptions, depth: number = 0): void => {
    // Ë∂ÖËøáÊúÄÂ§ßÊ∑±Â∫¶Êó∂ÔºåÊòæÁ§∫ÁúÅÁï•
    if (options.maxDepth && depth > options.maxDepth) {
        console.log(`%c...`, `color: ${COLORS.gray}`)
        return
    }

    // Ê†πÊçÆÁ±ªÂûãË∞ÉÁî®ÂØπÂ∫îÁöÑÊ†ºÂºèÂåñÂáΩÊï∞
    switch (tree.type) {
        case 'command':
            formatCommandTree(tree as CommandExecutionTree, options, depth)
            break
        case 'query':
            formatQueryTree(tree as QueryExecutionTree, options, depth)
            break
        case 'event':
            formatEventTree(tree as EventExecutionTree, options, depth)
            break
        default:
            // ÂÖúÂ∫ïÂ§ÑÁêÜ
            console.warn('Unknown execution tree type:', tree)
    }
}

export const PrettyLogger = (options: Partial<LoggerOptions> = {}) => {
    const config = { ...defaultOptions, ...options }

    return <State>(store: Store<State>) => {
        store.subscribeExecution((tree) => {
            formatExecutionTree(tree, config)
        })
    }
}
